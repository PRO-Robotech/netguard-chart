{{- $config         := .Values.backend.config -}}
{{- $authnConfig    := $config.authn -}}
{{- $clientCa       := index $authnConfig.tls.client "ca-files" -}}

{{- if .Values.backend.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    {{- include "netguard-chart.labels" . | nindent 4 }}
  name: {{ include "netguard-chart.fullname" . }}-backend-config
data:
  client-config: |
    app:
      name: "netguard-pg-backend"
      version: "v1.0.0"

    settings:
      sgroup-grpc-address: "{{ $config.sgroups_address }}"
      http-addr: ":{{ $backend.service.ports.http }}"
      grpc-addr: ":{{ $backend.service.ports.grpc }}"

    logger:
      log-level: {{ $backend.logLevel }}

    authn:
      # Type: tls, none.
      # "tls" - default value for kubernetes
      # "none" - disable tls
    {{- if (eq .Values.tls.certSource "none") }}
      type: "none"
      tls:
        client:
          verify: "skip"
    {{- else }}
      type: {{ $authnConfig.type | default "tls" }}
      tls:
        cert-file: "/etc/certs/tls.crt"
        key-file: "/etc/certs/tls.key"
        client:
          # skip - for self-signed certs
          verify: {{ $authnConfig.tls.client.verify | default "skip" }}
          {{- if $clientCa }}
          ca-files:
            {{ $clientCa | toYaml | nindent 12 }}
          {{- else }}
          ca-files: []
          {{- end }}

    sync:
      enabled: true

      sgroups:
        grpc_address: "{{ $config.sgroups_address }}"
        request_timeout: "30s"
        keep_alive:
          time: "60s"
          timeout: "15s"
          permit_without_stream: false
        tls:
          enabled: true
          cert_file: "/etc/certs/tls.crt"
          key_file: "/etc/certs/tls.key"
          ca_file: "/etc/certs/ca.crt"
          insecure_skip_verify: true

      retry:
        max_retries: 3
        initial_delay: 100
        max_delay: 5000
        backoff_factor: 2.0

      debounce:
        time: "5s"

      cleanup:
        interval: "10m"
        max_age: "1h"

    # Конфигурация обратной синхронизации (от SGROUP к NETGUARD)
    reverse_sync:
      # Настройки менеджера обратной синхронизации
      manager:
        auto_start: true
        processing_timeout: "30s"
        enable_statistics: true
        max_concurrent_processors: 5
        health_check_interval: "60s"

      # Настройки SGROUP детектора изменений
      sgroup_detector:
        reconnect_interval: "30s"
        max_retries: 10
        change_event_source: "sgroup"

      # Настройки синхронизатора хостов
      host_synchronizer:
        batch_size: 50
        max_concurrency: 5
        sync_timeout: "30s"
        enable_ip_set_validation: true
        namespace_filter: ""

      # Настройки процессора хостов
      host_processor:
        enable_namespace_filtering: false
        default_processing_mode: "full_sync"
        enable_batch_processing: true
        error_retry_limit: 3

      # Системные настройки
      system:
        log_level: "info"
        enable_metrics: true
        metrics_port: 8090
        graceful_shutdown_timeout: "30s"
        environment: "production"

    {{- end }}
{{- end }}
