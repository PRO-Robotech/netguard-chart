{{- $backend      := .Values.backend -}}
{{- $config       := $backend.config -}}
{{- $authnConfig  := $config.authn -}}
{{- $certFile     := (dig "tls" "cert-file" "/opt/h-bf/netguard/tls/tls.crt" $authnConfig) -}}
{{- $keyFile      := (dig "tls" "key-file" "/opt/h-bf/netguard/tls/tls.key" $authnConfig) -}}
{{- $clientCa     := (dig "tls" "client" "ca-files" (list "/opt/h-bf/netguard/tls/ca.crt") $authnConfig) -}}
{{- $clientVerify := (dig "tls" "client" "verify" "skip" $authnConfig) -}}

{{- if .Values.backend.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "netguard-chart.fullname" . }}-backend-config
  labels:
    app.kubernetes.io/component: backend
    {{- include "netguard-chart.labels" . | nindent 4 }}
data:
  client-config: |
    app:
      name: "netguard-pg-backend"
      version: "v1.0.0"

    settings:
      sgroup-grpc-address: "{{ $config.sgroups_address }}"
      http-addr: ":{{ $backend.service.ports.http }}"
      grpc-addr: ":{{ $backend.service.ports.grpc }}"

    logger:
      log-level: {{ $backend.logLevel }}

    authn:
      # Type: tls, none.
      # "tls" - default value for kubernetes
      # "none" - disable tls
    {{- if or (eq .Values.tls.certSource "none") (eq $authnConfig.type "none") }}
      type: "none"
      tls:
        client:
          verify: "skip"
    {{- else }}
      type: "tls"
      tls:
        cert-file: {{ $certFile }}
        key-file: {{ $keyFile }}
        client:
          # skip - for self-signed certs
          verify: {{ $clientVerify }}
          ca-files: {{ $clientCa | toYaml | nindent 12 }}
    {{- end }}

    sync:
      enabled: true

      sgroups:
        grpc_address: "{{ $config.sgroups_address }}"
        request_timeout: "30s"
        keep_alive:
          time: "60s"
          timeout: "15s"
          permit_without_stream: false
        tls:
        {{- if or (eq .Values.tls.certSource "none") (eq $authnConfig.type "none") }}
          enabled: false
        {{- else }}
          enabled: true
          cert_file: {{ $certFile }}
          key_file: {{ $keyFile }}
          {{ with $clientCa }}
          ca_file: {{ index . 0 }}
          {{- end }}
          insecure_skip_verify: {{ $clientVerify }}
        {{- end }}

      retry:
        max_retries: 3
        initial_delay: 100
        max_delay: 5000
        backoff_factor: 2.0

      debounce:
        time: "5s"

      cleanup:
        interval: "10m"
        max_age: "1h"

    # Конфигурация обратной синхронизации (от SGROUP к NETGUARD)
    reverse_sync:
      # Настройки менеджера обратной синхронизации
      manager:
        auto_start: true
        processing_timeout: "30s"
        enable_statistics: true
        max_concurrent_processors: 5
        health_check_interval: "60s"

      # Настройки SGROUP детектора изменений
      sgroup_detector:
        reconnect_interval: "30s"
        max_retries: 10
        change_event_source: "sgroup"

      # Настройки синхронизатора хостов
      host_synchronizer:
        batch_size: 50
        max_concurrency: 5
        sync_timeout: "30s"
        enable_ip_set_validation: true
        namespace_filter: ""

      # Настройки процессора хостов
      host_processor:
        enable_namespace_filtering: false
        default_processing_mode: "full_sync"
        enable_batch_processing: true
        error_retry_limit: 3

      # Системные настройки
      system:
        log_level: "info"
        enable_metrics: true
        metrics_port: 8090
        graceful_shutdown_timeout: "30s"
        environment: "production"
{{- end }}
